<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GPS Plot</title>
  <link rel="stylesheet" href="/uplot.css">
  <script src="/uplot.js"></script>
</head>
<body>
  <div id="plot" style="width:800px;height:600px;"></div>

  <script>
    let rawX = [], rawY = [];
    let filtX = [], filtY = [];
    let lastTimestamp = 0;

    const opts = {
      title: "GPS Lon vs Lat",
      width: 800,
      height: 600,
      scales: {
        x: {
          auto: false,
          time: false,
          min: -122.5,
          max: -122.0
        },
        y: {
          auto: false,
          min: 37.5,
          max: 38.0
        }
      },
      series: [
        {},  // x axis placeholder
        {
          label: "Raw",
          stroke: "red",
          width: 0,
          points: { show: true, size: 3, stroke: "red", fill: "red" }
        },
        {
          label: "Filtered",
          stroke: "blue",
          width: 1.5,
          points: { show: false }
        }
      ],
      axes: [
        { label: "Longitude" },
        { label: "Latitude" }
      ]
    };

    const u = new uPlot(opts, [[], [], []], document.getElementById("plot"));

    function updatePlot() {
      const count = Math.min(rawX.length, filtX.length);
      const allX = rawX.map((val, i) => val !== null ? val : filtX[i]);
      const rawOnlyY = rawY.map((val, i) => val !== null ? val : null);
      const filteredY = filtY;

      u.setData([allX, rawOnlyY, filteredY]);
    }

    function fetchData() {
      // Fetch most recent fix
      fetch('/location')
        .then(r => r.json())
        .then(d => {
          if (d.raw && d.filtered) {
            rawX.push(d.raw.lon);
            rawY.push(d.raw.lat);
            filtX.push(d.filtered.lon);
            filtY.push(d.filtered.lat);
          }

          if (rawX.length > 1000) {
            rawX.shift(); rawY.shift(); filtX.shift(); filtY.shift();
          }

          updatePlot();
        });

      // Fetch buffered points
      fetch(`/buffer?after=${lastTimestamp}`)
        .then(r => r.json())
        .then(points => {
          points.forEach(p => {
            if (p.raw && p.filtered) {
              rawX.push(p.raw.lon);
              rawY.push(p.raw.lat);
              filtX.push(p.filtered.lon);
              filtY.push(p.filtered.lat);
            } else {
              rawX.push(null);
              rawY.push(null);
              filtX.push(null);
              filtY.push(null);
            }

            if (p.timestamp > lastTimestamp) {
              lastTimestamp = p.timestamp;
            }
          });

          while (rawX.length > 1000) {
            rawX.shift(); rawY.shift(); filtX.shift(); filtY.shift();
          }

          updatePlot();
        });
    }

    setInterval(fetchData, 5000);
  </script>
</body>
</html>
